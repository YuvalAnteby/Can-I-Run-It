name: CI - PR Checks

on:
  pull_request:
    branches: [ staging, main ]
    paths:
      - 'backend/**'
      - 'infra/**'
      - '.github/workflows/backend-ci.yml'
      - '!**/*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. TESTS WITHOUT DOCKER (Lint & Unit Tests)
  static_analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npm run test

  # 2. TESTS WITH DOCKER (Integration / E2E)
  integration_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: static_analysis
    steps:
      - uses: actions/checkout@v4
      # ... (Your existing .env creation logic) ...
      - name: Create test .env file
        run: |
          cat > infra/.env << EOF
          PORT=3000
          NODE_ENV=test
          POSTGRES_HOST=postgres-test
          POSTGRES_PORT=5432
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=password
          POSTGRES_DB=test_db
          JWT_SECRET=test-jwt-secret-for-ci
          EOF
          
      - uses: docker/setup-buildx-action@v3
      # ... (Your existing Cache logic) ...
      
      - name: Run E2E Tests
        run: |
          docker compose -f infra/docker-compose.tests.yml up --build --exit-code-from backend --abort-on-container-exit

  # 3. BUILD CHECK (Only verifying Dockerfile works correctly)
  dry_run_build:
    runs-on: ubuntu-latest
    needs: integration_tests
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Verify Docker Build
        run: |
          docker build -f infra/Dockerfile.backend -t temp-check:latest ./backend