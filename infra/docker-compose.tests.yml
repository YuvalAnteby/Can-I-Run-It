name: ciri-tests
services:
  mongodb-test:
    image: mongo:7.0.15
    container_name: ciri-mongo-test
    tmpfs:
      - /data/db  # In-memory for speed
    networks:
      - test-net

  backend-lint:
    build:
      context: ..
      dockerfile: ./infra/Dockerfile.backend.tests
      target: lint   # ‚Üê important! run the lint stage
    container_name: ciri-lint
    volumes:
      - ../backend:/app/backend

  backend-test:
    build:
      context: ..
      dockerfile: ./infra/Dockerfile.backend.tests
    container_name: ciri-tests
    depends_on:
      - mongodb-test
    environment:
      - MONGODB_URI=mongodb://mongodb-test:27017
      - ENVIRONMENT=testing
      - TEST_TYPE=   # empty = run all stages
      - MONGO_PORT=27017
      - ALLOWED_ORIGINS=http://localhost:3000
    volumes:
      - ../backend:/app/backend
      - ./backend-test-results:/app/backend-test-results
    networks:
      - test-net

networks:
  test-net: